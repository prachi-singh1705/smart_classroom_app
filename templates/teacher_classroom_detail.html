{% extends "base.html" %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <a class="btn btn-link" href="/teacher/classes">&larr; Back</a>
    <h3 id="className">Class</h3>
    <div id="classMeta" class="small text-muted"></div>
  </div>
  <div>
    <button class="btn btn-outline-primary" id="studentsBtn">Students</button>
    <button class="btn btn-outline-secondary" id="attendanceBtn">Attendance</button>
    <button class="btn btn-main" id="assignBtn">Assign Task</button>
    <button class="btn btn-light" id="timetableBtn">Time Table</button>
  </div>
</div>

<div id="panelArea">

  <!-- Students -->
  <div id="studentsPanel" class="panel" style="display:none;">
    <h5>Students</h5>
    <div id="studentsList"></div>
  </div>

  <!-- Attendance -->
  <div id="attendancePanel" class="panel" style="display:none;">
    <h5>Sessions</h5>
    <div id="sessionsList"></div>
  </div>

  <!-- Assignment -->
  <div id="assignPanel" class="panel" style="display:none;">
    <h5>Create Assignment</h5>
    <form id="assignForm">
      <input name="title" class="form-control mb-2" placeholder="Title" required>
      <textarea name="description" class="form-control mb-2"></textarea>
      <input type="date" name="due_date" class="form-control mb-2">
      <button class="btn btn-main">Create</button>
    </form>
    <div id="assignResult"></div>
  </div>

  <!-- Timetable -->
  <div id="timetablePanel" class="panel" style="display:none;">
    <h5>Timetable</h5>

    <div class="d-flex gap-2 mb-3">
      <select id="ttDay" class="form-select">
        <option value="">Day</option>
        <option>Monday</option><option>Tuesday</option>
        <option>Wednesday</option><option>Thursday</option>
        <option>Friday</option><option>Saturday</option>
      </select>

      <select id="ttPeriod" class="form-select">
        <option value="">Period</option>
        {% for i in range(1,9) %}
        <option value="{{ i }}">{{ i }}</option>
        {% endfor %}
      </select>

      <input type="time" id="ttStart" class="form-control">
      <input type="time" id="ttEnd" class="form-control">

      <button type="button" class="btn btn-main" id="addTtBtn">Add</button>
    </div>

    <table class="table table-sm">
      <thead>
        <tr><th>Day</th><th>Period</th><th>Time</th><th></th></tr>
      </thead>
      <tbody id="ttTableBody"></tbody>
    </table>
  </div>
</div>

<script>
const classId = parseInt(location.pathname.split('/').pop());

function closePanels(){
  document.querySelectorAll('.panel').forEach(p=>p.style.display='none');
}

studentsBtn.onclick = ()=>{ closePanels(); studentsPanel.style.display='block'; };
attendanceBtn.onclick = ()=>{ closePanels(); attendancePanel.style.display='block'; };
assignBtn.onclick = ()=>{ closePanels(); assignPanel.style.display='block'; };
timetableBtn.onclick = ()=>{ closePanels(); timetablePanel.style.display='block'; loadTimetable(); };

async function loadMeta(){
  const r = await fetch(`/api/classes/teacher/${classId}/detail`);
  const j = await r.json();
  className.innerText = j.class.name;
  classMeta.innerText = `Code: ${j.class.code}`;
}
loadMeta();

/* ADD TIMETABLE */
addTtBtn.onclick = async () => {
  const payload = {
    class_id: classId,
    day: ttDay.value,
    period: ttPeriod.value,
    start_time: ttStart.value,
    end_time: ttEnd.value
  };

  if (Object.values(payload).some(v=>!v)) {
    alert("Fill all fields");
    return;
  }

  const res = await fetch("/api/timetable/teacher/timetable/add", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify(payload)
  });

  const data = await res.json();
  if(!res.ok) return alert(data.error);

  loadTimetable();
};

/* LOAD TIMETABLE */
async function loadTimetable(){
  const r = await fetch(`/api/timetable/teacher/timetable/${classId}`);
  const arr = await r.json();

  ttTableBody.innerHTML = arr.map(e=>`
    <tr>
      <td>${e.day}</td>
      <td>${e.period}</td>
      <td>${e.start_time} - ${e.end_time}</td>
      <td>
        <button class="btn btn-danger btn-sm"
          onclick="deleteEntry(${e.id})">Delete</button>
      </td>
    </tr>
  `).join('');
}

async function deleteEntry(id){
  await fetch(`/api/timetable/teacher/timetable/${id}`, {method:"DELETE"});
  loadTimetable();
}
</script>

{% endblock %}
